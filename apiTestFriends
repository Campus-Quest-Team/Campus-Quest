#!/bin/bash

# A script to test the full friends workflow: add, remove, and fetch.
# It logs in, then adds, removes, and fetches a specific user's friends list.

# --- Configuration ---
API_BASE_URL="http://localhost:5001/api"
ADD_FRIEND_URL="$API_BASE_URL/addFriend"
REMOVE_FRIEND_URL="$API_BASE_URL/removeFriend"
FETCH_FRIENDS_URL="$API_BASE_URL/fetchFriends"
LOGIN_SCRIPT="./apiTestLogin.sh"

# !! IMPORTANT !!
# Manually set the friend's user ID you want to test with here.
FRIEND_ID_TO_TEST="686e9375f6f1b4f03cf038df"


# --- Step 1: Login to get credentials ---
echo "Attempting to log in..."

if [ ! -f "$LOGIN_SCRIPT" ]; then
    echo "Error: Login script not found at '$LOGIN_SCRIPT'"
    exit 1
fi

source "$LOGIN_SCRIPT"

if [ -z "$JWT_TOKEN" ] || [ -z "$USER_ID" ]; then
    echo "Failed to obtain JWT token or User ID from login script."
    exit 1
fi

echo "Login successful. User ID: $USER_ID"
echo "-----------------------------------"
echo ""

# --- Step 2: Call addFriend endpoint ---
echo "Attempting to add user $FRIEND_ID_TO_TEST as a friend to user $USER_ID..."

add_friend_response=$(curl -s -X POST \
  -H "Content-Type: application/json" \
  -d "{\"userId\":\"$USER_ID\", \"friendId\":\"$FRIEND_ID_TO_TEST\", \"jwtToken\":\"$JWT_TOKEN\"}" \
  $ADD_FRIEND_URL)

echo "addFriend response:"
echo "$add_friend_response" | jq '.'

if [ $? -ne 0 ]; then
    echo "Error: Failed to parse addFriend response with jq."
    echo "Raw response: $add_friend_response"
    exit 1
fi

# --- Step 3: Call removeFriend endpoint ---
echo ""
echo "-----------------------------------"
echo "Attempting to remove user $FRIEND_ID_TO_TEST as a friend from user $USER_ID..."

remove_friend_response=$(curl -s -X POST \
  -H "Content-Type: application/json" \
  -d "{\"userId\":\"$USER_ID\", \"friendId\":\"$FRIEND_ID_TO_TEST\", \"jwtToken\":\"$JWT_TOKEN\"}" \
  $REMOVE_FRIEND_URL)

echo "removeFriend response:"
echo "$remove_friend_response" | jq '.'

if [ $? -ne 0 ]; then
    echo "Error: Failed to parse removeFriend response with jq."
    echo "Raw response: $remove_friend_response"
    exit 1
fi

# --- Step 4: Call fetchFriends endpoint ---
echo ""
echo "-----------------------------------"
echo "Fetching final friend list for user $USER_ID..."

fetch_friends_response=$(curl -s -X POST \
  -H "Content-Type: application/json" \
  -d "{\"userId\":\"$USER_ID\", \"jwtToken\":\"$JWT_TOKEN\"}" \
  $FETCH_FRIENDS_URL)

echo "fetchFriends response:"
echo "$fetch_friends_response" | jq '.'

if [ $? -ne 0 ]; then
    echo "Error: Failed to parse fetchFriends response with jq."
    echo "Raw response: $fetch_friends_response"
    exit 1
fi

echo ""
echo "Script finished." 